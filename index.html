<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KneeCapacity</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="custom-styles.css">
    <link rel="stylesheet" href="stopwatch-styles.css">
    <link rel="stylesheet" href="measurement-styles.css">
    <link rel="stylesheet" href="event-styles.css">
    <link rel="stylesheet" href="toggle-fix.css">
</head>
<body>
    <header>
        <h1>üí™ KneeCapacity</h1>
        <div id="header-badges" class="header-badges"></div>
    </header>

    <main id="app-content">
        <div id="home-view" class="view active">
            <div id="home-streak-card" class="streak-card-large">
                <div class="streak-number"><span id="home-streak-count">0</span></div>
                <div class="streak-label">DAY STREAK</div>
                <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px; opacity: 0.9;">
                    TOTAL WORKOUTS: <span id="home-total-workouts">0</span>
                </div>
                <div id="home-milestone-badges" class="home-badges"></div>
            </div>

            <section id="knee-status-card" class="status-card text-center">
                <div class="status-icon">‚ùì</div>
                <h2>Complete Check-In</h2>
            </section>

            <section id="lane-guidance-card" class="card" style="display: none;">
                <h3 style="margin-top: 0; color: var(--primary);">üõ§Ô∏è Your Training Lane</h3>
                <div id="lane-options" class="lane-options" style="display: flex; gap: 8px; margin: 16px 0;">
                    <!-- Lane buttons will be injected here -->
                </div>
                <div id="lane-explanation" style="font-size: 14px; color: var(--gray-600); line-height: 1.4;">
                    Select a lane based on today's status.
                </div>
            </section>

            <section class="card">
                <h2>Daily Check-In</h2>
                <div class="form-group">
                    <label>Swelling</label>
                    <div class="swelling-group">
                        <button class="swelling-btn" data-level="none">&#128994; None</button>
                        <button class="swelling-btn" data-level="mild">&#128993; Mild</button>
                        <button class="swelling-btn" data-level="moderate">&#128992; Mod</button>
                        <button class="swelling-btn" data-level="severe">&#128308; Bad</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Pain: <span id="pain-value">0</span>/10</label>
                    <input type="range" id="pain-slider" min="0" max="10" value="0" class="slider" oninput="document.getElementById('pain-value').textContent=this.value">
                </div>
                <div class="form-group">
                    <label>Activity</label>
                    <div class="activity-group">
                        <button class="activity-level-btn active" data-level="light">üö∂ Light</button>
                        <button class="activity-level-btn" data-level="moderate">üèÉ Moderate</button>
                        <button class="activity-level-btn" data-level="active">üí™ Active</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <div class="time-group">
                        <button class="time-btn active" data-time="morning">üåÖ AM</button>
                        <button class="time-btn" data-time="afternoon">‚òÄÔ∏è PM</button>
                        <button class="time-btn" data-time="evening">üåô Eve</button>
                    </div>
                </div>
                <div class="form-group"><label>Notes</label><textarea id="checkin-notes" rows="2"></textarea></div>
                <button class="primary-button" id="save-checkin" onclick="saveCheckIn()">Save Check-In</button>
            </section>

            <section class="card"><h3>This Week</h3><div id="week-summary"></div></section>

            <section class="card clickable-card" onclick="openMeasurementModal()">
                <h3 style="color: #1976D2;">üìè Body Measurements</h3>
                <p id="last-measurement-date" style="font-size: 14px; margin: 8px 0 0 0;">Tap to add</p>
            </section>

            <section class="card clickable-card" onclick="openEventModal()">
                <h3 style="color: #F44336;">‚ö†Ô∏è Significant Event</h3>
                <p style="font-size: 14px; margin: 8px 0 0 0;">Log incident for specialist</p>
                <div id="recent-events-preview" style="margin-top: 12px;">
                    <!-- Recent events preview -->
                </div>
            </section>

            <section class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="form-group">
                    <label>Patient Name (for PDF reports)</label>
                    <input type="text" id="patient-name" placeholder="Enter your name" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                </div>
                <button class="secondary-button" onclick="savePatientName()" style="margin-top: 8px;">Save Name</button>
            </section>
        </div>

            <div id="log-view" class="view">
                <h2>Log Workout</h2>

                <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
                    <button id="toggle-exercises" class="secondary-button active">Exercises</button>
                    <button id="toggle-custom" class="secondary-button">Custom</button>
                </div>

                <h3>Quick Log</h3>
                <div class="exercise-tiles" id="exercise-tiles"></div>
                <div id="custom-workout-tiles" class="exercise-tiles" style="display:none; margin-top:12px;">
                    <div class="exercise-tile" onclick="selectCustomWorkout('peloton')">üö¥ Peloton</div>
                    <div class="exercise-tile" onclick="selectCustomWorkout('rowing')">üö£ Rowing</div>
                    <div class="exercise-tile" onclick="selectCustomWorkout('core')">üéØ Core</div>
                    <div class="exercise-tile" onclick="selectCustomWorkout('stretch')">üßò Stretch</div>
                    <div class="exercise-tile" onclick="selectCustomWorkout('upper')">üí™ Upper</div>
                    <div class="exercise-tile" onclick="selectCustomWorkout('bike')">üö¥ Bike</div>
                </div>
            </section>

            <section class="card" id="exercise-log-form" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3 id="selected-exercise-name" style="margin: 0;">Exercise</h3>
                    <button id="close-form" class="secondary-button" style="width: auto; margin: 0; padding: 8px 16px;">Close</button>
                </div>

                <!-- Exercise Instructions -->
                <div id="exercise-instructions" class="exercise-instructions">
                    <button id="toggle-instructions" class="toggle-instructions-btn">
                        <span id="toggle-instructions-icon">‚ñº</span> How to Perform
                    </button>
                    <div id="instructions-content" class="instructions-content">
                        <div class="instructions-section">
                            <strong>SETUP:</strong>
                            <ul id="setup-list"></ul>
                        </div>
                        <div class="instructions-section">
                            <strong>EXECUTION:</strong>
                            <ul id="execution-list"></ul>
                        </div>
                        <div class="instructions-section">
                            <strong>Target:</strong> <span id="target-muscles"></span>
                        </div>
                        <div id="instructions-tempo" class="instructions-section" style="display:none;">
                            <strong>Tempo:</strong> <span id="tempo-display"></span>
                        </div>
                    </div>
                </div>

                <!-- Primary Metrics -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div class="form-row" style="margin: 0;">
                        <label>Sets</label>
                        <div class="input-stepper">
                            <button type="button" onclick="adjustValue('sets-completed',-1)">‚àí</button>
                            <input id="sets-completed" type="number" value="3" inputmode="numeric">
                            <button type="button" onclick="adjustValue('sets-completed',1)">+</button>
                        </div>
                    </div>
                    <div class="form-row" style="margin: 0;">
                        <label>Reps</label>
                        <div class="input-stepper">
                            <button type="button" onclick="adjustValue('reps-completed',-1)">‚àí</button>
                            <input id="reps-completed" type="number" value="10" inputmode="numeric">
                            <button type="button" onclick="adjustValue('reps-completed',1)">+</button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div class="form-row" id="hold-tracker" style="margin: 0;">
                        <label>Hold (sec)</label>
                        <div class="input-stepper">
                            <button type="button" onclick="adjustValue('hold-time',-5)">‚àí</button>
                            <input id="hold-time" type="number" value="0" inputmode="numeric">
                            <button type="button" onclick="adjustValue('hold-time',5)">+</button>
                        </div>
                    </div>
                    <div class="form-row" style="margin: 0;">
                        <label>Weight (lb)</label>
                        <div class="input-stepper">
                            <button type="button" onclick="adjustValue('weight-used',-5)">‚àí</button>
                            <input id="weight-used" type="number" value="0" inputmode="numeric">
                            <button type="button" onclick="adjustValue('weight-used',5)">+</button>
                        </div>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 24px;">
                    <label>Difficulty (1-10): <span id="rpe-value">5</span></label>
                    <input type="range" id="rpe-slider" min="1" max="10" value="5" class="slider" oninput="document.getElementById('rpe-value').textContent=this.value">
                </div>

                <div class="form-row" style="margin-bottom: 24px;">
                    <label>Knee Pain During Exercise (0-10): <span id="exercise-pain-value">0</span></label>
                    <input type="range" id="exercise-pain-slider" min="0" max="10" value="0" class="slider" oninput="document.getElementById('exercise-pain-value').textContent=this.value">
                </div>

                <!-- Timer Section -->
                <div id="form-timer-section" style="margin-bottom: 24px;">
                    <button id="toggle-form-timer" class="secondary-button" style="margin: 0; background: #f5f5f5; border-color: #e0e0e0; color: #444;">
                        ‚è±Ô∏è Show Timer
                    </button>
                    
                    <div id="embedded-stopwatch" class="embedded-stopwatch" style="display: none;">
                        <div id="stopwatch-display" class="stopwatch-display">00:00</div>
                        <div class="stopwatch-controls">
                            <button id="stopwatch-start" class="stopwatch-btn start">Start</button>
                            <button id="stopwatch-stop" class="stopwatch-btn stop" disabled>Stop</button>
                            <button id="stopwatch-reset" class="stopwatch-btn reset">Reset</button>
                        </div>
                        <div id="milestone-badges" class="milestone-container" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-row">
                    <label>Notes</label>
                    <textarea id="exercise-notes" rows="2" style="width: 100%; border-radius: 12px; border: 2px solid var(--gray-300); padding: 12px;"></textarea>
                </div>
                
                <div id="trend-chart" style="margin-top:20px;"></div>
                <button id="save-exercise" class="primary-button" type="button" style="margin-top: 24px;">‚úÖ Log Workout</button>
            </section>

            <section class="card" id="custom-workout-form" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="custom-workout-title">Custom</h3>
                    <button id="close-custom-form" class="secondary-button" type="button">Close</button>
                </div>
                <div class="form-row" style="margin-bottom: 24px;">
                    <label>Duration (min)</label>
                    <div class="input-stepper">
                        <button type="button" onclick="adjustValue('custom-duration',-5)">‚àí</button>
                        <input id="custom-duration" type="number" value="20" inputmode="numeric">
                        <button type="button" onclick="adjustValue('custom-duration',5)">+</button>
                    </div>
                </div>
                <div class="form-row">
                    <label>Intensity: <span id="custom-intensity-value">5</span>/10</label>
                    <input type="range" id="custom-intensity" min="1" max="10" value="5">
                </div>
                <div class="form-row">
                    <label>Type</label>
                    <input id="custom-workout-type" type="text" placeholder="e.g. Intervals">
                </div>
                <div class="form-row">
                    <label>Impact</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="impact-btn secondary-button" data-impact="none" type="button">None</button>
                        <button class="impact-btn secondary-button" data-impact="low" type="button">Low</button>
                        <button class="impact-btn secondary-button" data-impact="moderate" type="button">Moderate</button>
                        <button class="impact-btn secondary-button" data-impact="high" type="button">High</button>
                    </div>
                </div>
                <div class="form-row">
                    <label>Notes</label>
                    <textarea id="custom-notes" rows="2"></textarea>
                </div>
                <div id="custom-history-list" style="margin:8px 0;"></div>
                <button id="save-custom-workout" class="primary-button" type="button">‚úÖ Log</button>
            </section>

            <section class="card">
                <h3>Today</h3>
                <div id="todays-exercise-list"></div>
            </section>
        </div>

        <div id="history-view" class="view">
            <h2>Analytics</h2>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="total-workouts">0</div><div class="stat-label">Workouts</div></div>
                <div class="stat-card"><div class="stat-value" id="total-exercises">0</div><div class="stat-label">Exercises</div></div>
                <div class="stat-card"><div class="stat-value" id="avg-pain">0</div><div class="stat-label">Avg Pain</div></div>
                <div class="stat-card"><div class="stat-value" id="green-days">0</div><div class="stat-label">Green Days</div></div>
            </div>
            <div class="card" style="margin-top:12px;">
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items:center; justify-content:space-between;">
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="filter-btn secondary-button active" data-days="7">7d</button>
                    <button class="filter-btn secondary-button" data-days="30">30d</button>
                    <button class="filter-btn secondary-button" data-days="90">90d</button>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button id="export-json" class="secondary-button" type="button">Export JSON</button>
                        <button id="export-pdf" class="secondary-button" type="button" style="background: var(--primary); color: white;">Export PDF</button>
                    </div>
                </div>
                <div id="swelling-chart" class="chart-container"></div>
                <div id="pain-chart" class="chart-container" style="margin-top:16px;"></div>
                <div id="workout-frequency-chart" class="chart-container" style="margin-top:16px;"></div>
                <div id="exercise-breakdown" style="margin-top:16px;"></div>
                <div style="margin-top:16px;">
                    <label for="analytics-exercise-select">Exercise detail</label>
                    <select id="analytics-exercise-select" style="width:100%; padding:8px; margin-top:6px;"></select>
                    <div id="exercise-analytics" style="margin-top:12px;"></div>
                </div>
            </div>
            <div id="history-list"></div>
            
            <section class="card" style="margin-top:16px;">
                <h3>‚ö†Ô∏è Significant Events (Last 90 Days)</h3>
                <div id="events-timeline"></div>
            </section>
            
            <div id="measurement-summary" class="card" style="margin-top:16px;"></div>
        </div>

        <div id="exercises-view" class="view">
            <h2>Library</h2>
            <div id="exercise-library"></div>
        </div>
    </main>

    <div id="measurement-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìè Measurements</h2>
                <button onclick="closeMeasurementModal()" class="close-btn">x</button>
            </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <label>Height (cm)</label>
                        <div class="input-stepper">
                            <button type="button" onclick="adjustValue('height',-1)">‚àí</button>
                            <input type="number" id="height" step="1" inputmode="numeric">
                            <button type="button" onclick="adjustValue('height',1)">+</button>
                        </div>
                    </div>
                    <h4>Measurements (cm)</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label>Knee Right</label>
                            <div class="input-stepper">
                                <button type="button" onclick="adjustValue('knee-right',-0.1)">‚àí</button>
                                <input type="number" id="knee-right" step="0.1" inputmode="decimal">
                                <button type="button" onclick="adjustValue('knee-right',0.1)">+</button>
                            </div>
                        </div>
                        <div>
                            <label>Knee Left</label>
                            <div class="input-stepper">
                                <button type="button" onclick="adjustValue('knee-left',-0.1)">‚àí</button>
                                <input type="number" id="knee-left" step="0.1" inputmode="decimal">
                                <button type="button" onclick="adjustValue('knee-left',0.1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div>
                            <label>Thigh Right</label>
                            <div class="input-stepper">
                                <button type="button" onclick="adjustValue('thigh-right',-0.1)">‚àí</button>
                                <input type="number" id="thigh-right" step="0.1" inputmode="decimal">
                                <button type="button" onclick="adjustValue('thigh-right',0.1)">+</button>
                            </div>
                        </div>
                        <div>
                            <label>Thigh Left</label>
                            <div class="input-stepper">
                                <button type="button" onclick="adjustValue('thigh-left',-0.1)">‚àí</button>
                                <input type="number" id="thigh-left" step="0.1" inputmode="decimal">
                                <button type="button" onclick="adjustValue('thigh-left',0.1)">+</button>
                            </div>
                        </div>
                    </div>
                    <details>
                        <summary style="cursor: pointer; padding: 12px; background: #f5f5f5; border-radius: 8px;">‚ûï Optional</summary>
                        <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div>
                                <label>Waist (cm)</label>
                                <div class="input-stepper">
                                    <button type="button" onclick="adjustValue('waist',-0.5)">‚àí</button>
                                    <input type="number" id="waist" step="0.1" inputmode="decimal">
                                    <button type="button" onclick="adjustValue('waist',0.5)">+</button>
                                </div>
                            </div>
                            <div>
                                <label>Weight (lbs)</label>
                                <div class="input-stepper">
                                    <button type="button" onclick="adjustValue('weight',-1)">‚àí</button>
                                    <input type="number" id="weight" step="0.1" inputmode="decimal">
                                    <button type="button" onclick="adjustValue('weight',1)">+</button>
                                </div>
                            </div>
                        </div>
                    </details>
                <div style="margin:12px 0;">
                    <label>Posture</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="posture-btn secondary-button active" data-posture="relaxed" type="button">Relaxed</button>
                        <button class="posture-btn secondary-button" data-posture="flexed" type="button">Flexed</button>
                    </div>
                </div>
                <div class="form-group"><label>Notes</label><textarea id="measurement-notes" rows="2"></textarea></div>
                <button class="primary-button" id="save-measurement" onclick="saveMeasurement()">üíæ Save</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="event-modal-title">‚ö†Ô∏è Log Significant Event</h2>
                <button onclick="closeEventModal()" class="close-btn">x</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="event-id">
                
                <div class="form-group">
                    <label>Event Type</label>
                    <select id="event-type" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                        <option value="pain_spike">‚ö° Pain Spike</option>
                        <option value="instability">‚ö†Ô∏è Instability Event</option>
                        <option value="mechanical">‚öôÔ∏è Mechanical Symptoms</option>
                        <option value="swelling_spike">üíß Swelling Spike</option>
                        <option value="post_activity_flare">üî• Post-Activity Flare</option>
                        <option value="other">üìù Other</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label>Date</label>
                        <input type="date" id="event-date" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                    </div>
                    <div>
                        <label>Time</label>
                        <input type="time" id="event-time" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Pain Level During Event: <span id="event-pain-value">5</span>/10</label>
                    <input type="range" id="event-pain-slider" min="0" max="10" value="5" class="slider">
                </div>
                
                <div class="form-group">
                    <label>What were you doing?</label>
                    <input type="text" id="event-activity" placeholder="e.g., Playing volleyball, descending stairs..." style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                </div>
                
                <div class="form-group">
                    <label>Duration</label>
                    <select id="event-duration" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                        <option value="< 1 hour">< 1 hour</option>
                        <option value="1-6 hours">1-6 hours</option>
                        <option value="6-24 hours">6-24 hours</option>
                        <option value="1-2 days">1-2 days</option>
                        <option value="3-7 days">3-7 days</option>
                        <option value="> 7 days (ongoing)">> 7 days (ongoing)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>What helped? (Resolution)</label>
                    <input type="text" id="event-resolution" placeholder="e.g., Ice, rest, medication..." style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;">
                </div>
                
                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="event-notes" rows="3" placeholder="Additional details..." style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid var(--gray-300); border-radius: 8px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 700; color: #F44336;">üö® Red Flag Indicators</label>
                    <div style="background: #FFEBEE; padding: 12px; border-radius: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="flag-locking" style="width: 20px; height: 20px; margin-right: 8px;">
                            <span>Knee locked/caught</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="flag-cant-bear-weight" style="width: 20px; height: 20px; margin-right: 8px;">
                            <span>Couldn't bear weight</span>
                        </label>
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" id="flag-severe-swelling" style="width: 20px; height: 20px; margin-right: 8px;">
                            <span>Severe swelling >7 days</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="flag-giving-way" style="width: 20px; height: 20px; margin-right: 8px;">
                            <span>Sudden giving way</span>
                        </label>
                    </div>
                </div>
                
                <button class="primary-button" id="save-event" style="margin-top: 16px;">üíæ Save Event</button>
            </div>
        </div>
    </div>

    <nav id="bottom-nav">
        <button class="nav-btn active" data-view="home"><span class="nav-icon">üè†</span><span class="nav-label">Home</span></button>
        <button class="nav-btn" data-view="log"><span class="nav-icon">üìù</span><span class="nav-label">Log</span></button>
        <button class="nav-btn" data-view="history"><span class="nav-icon">üìä</span><span class="nav-label">Stats</span></button>
        <button class="nav-btn" data-view="exercises"><span class="nav-icon">üí™</span><span class="nav-label">Library</span></button>
    </nav>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="exercises.js"></script>
    <script src="data.js"></script>
    <script src="app.bundle.js"></script>
</body>
</html>
